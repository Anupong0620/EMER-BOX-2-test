<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Emergency Med Box</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600&display=swap');
    body { font-family: 'Sarabun', sans-serif; }
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 4px 16px rgba(0,0,0,.05)}
    .btn{border-radius:.5rem;padding:.5rem .9rem;border:1px solid #e5e7eb;background:#f8fafc; transition: all 0.2s;}
    .btn:active { transform: scale(0.95); }
    .btn.primary{background:#2563eb;color:#fff;border-color:#2563eb}
    .muted{color:#64748b}
    .chip{background:#eef2ff;border:1px solid #c7d2fe;border-radius:9999px;padding:.25rem .6rem;font-size:.75rem}
    thead th{background:#f1f5f9}
    .stepper{display:flex;align-items:center;gap:.25rem}
    .stepper button{width:32px;height:32px;border:1px solid #e5e7eb;border-radius:.5rem;background:#fff; cursor: pointer;}
    .stepper input{width:72px;text-align:center;border:1px solid #e5e7eb;border-radius:.5rem;padding:.35rem}
    #apiBanner{display:none}
    .badge-nearest{background:#fef3c7;border:1px solid #f59e0b;color:#92400e;padding:.15rem .5rem;border-radius:9999px;font-size:.75rem}
    .near-first{background:#fffbeb;border-color:#fbbf24}
  </style>
</head>
<body class="bg-slate-50 text-slate-800 pb-10">
<div class="max-w-5xl mx-auto p-4 md:p-6">

  <div id="apiBanner" class="mb-3 rounded-lg border border-amber-300 bg-amber-50 text-amber-800 px-3 py-2 text-sm"></div>

  <header class="flex items-center justify-between mb-4">
    <div class="flex items-center gap-2">
      <h1 class="text-2xl font-bold text-blue-800">Drug Box Check</h1>
      <span id="boxBadge" class="chip hidden font-semibold text-blue-700"></span>
    </div>
    <button id="qrBtn" class="btn text-sm">QR Code</button>
  </header>

  <div class="grid grid-cols-2 gap-3 mb-4">
    <button id="tab-form" class="btn card text-center py-3 font-semibold text-blue-600 border-blue-200">üìù ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    <button id="tab-view" class="btn card text-center py-3 font-semibold text-slate-600">üìä ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</button>
  </div>

  <section id="view-form" class="card p-4">
    <h2 class="text-xl font-semibold mb-4 border-b pb-2">‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ/‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏¢‡∏≤</h2>

    <div class="grid md:grid-cols-2 gap-4">
      <div>
        <label class="block text-sm mb-1 font-medium">1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏¢‡∏≤</label>
        <select id="boxSelect" class="border rounded px-3 py-2 w-full bg-slate-50"></select>
      </div>
      <div>
        <label class="block text-sm mb-1 font-medium">2. ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à/‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô</label>
        <input type="date" id="dateVisit" class="border rounded px-3 py-2 w-full bg-slate-50">
      </div>

      <div>
        <label class="block text-sm mb-1 font-medium">3. ‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</label>
        <select id="inspector" class="border rounded px-3 py-2 w-full bg-slate-50">
          <option value="">- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ -</option>
          <option>‡∏†‡∏ç.‡∏û‡∏ô‡∏≤‡∏£‡∏±‡∏ï‡∏ô‡πå</option>
          <option>‡∏†‡∏ç.‡∏û‡∏±‡∏ä‡∏£‡∏µ‡∏ß‡∏£‡∏£‡∏ì</option>
          <option>‡∏†‡∏Å.‡∏≠‡∏ô‡∏∏‡∏û‡∏á‡∏®‡πå</option>
          <option>‡∏†‡∏ç.‡∏≠‡∏†‡∏¥‡∏ç‡∏ç‡∏≤</option>
          <option>‡∏†‡∏ç.‡∏™‡∏∏‡∏£‡∏µ‡∏ß‡∏±‡∏í‡∏ô‡πå</option>
          </select>
      </div>

      <div>
        <label class="block text-sm mb-1 font-medium">4. ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
        <div class="flex flex-wrap items-center gap-3 text-sm">
          <label class="inline-flex items-center gap-1 cursor-pointer"><input type="radio" name="reason" value="‡∏¢‡∏≤‡πÉ‡∏Å‡∏•‡πâ EXP"> ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏¢‡∏≤‡πÉ‡∏Å‡∏•‡πâ EXP</label>
          <label class="inline-flex items-center gap-1 cursor-pointer"><input type="radio" name="reason" value="‡πÉ‡∏ä‡πâ‡∏¢‡∏≤‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á" checked> ‡πÉ‡∏ä‡πâ‡∏¢‡∏≤‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</label>
          <label class="inline-flex items-center gap-1 cursor-pointer"><input type="radio" name="reason" value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ"> ‡∏≠‡∏∑‡πà‡∏ô‡πÜ</label>
          <input id="reasonOther" class="border rounded px-2 py-1 w-full mt-1 hidden" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•...">
        </div>
      </div>

      <div class="md:col-span-2 bg-blue-50 p-3 rounded-lg border border-blue-100">
        <label class="block text-sm mb-1 font-bold text-blue-800">5. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤</label>
        <select id="drugSelect" class="border rounded px-3 py-2 w-full bg-white"></select>
      </div>
    </div>

    <div class="mt-6">
      <h3 class="font-semibold mb-2 flex items-center gap-2">üì¶ ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô <span class="text-xs font-normal text-slate-500">(‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ï‡∏±‡∏î‡∏≠‡∏≠‡∏Å)</span></h3>
      <div class="overflow-x-auto rounded-lg border">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-100">
            <tr>
              <th class="p-3 text-left">Lot EXP (‡∏ß/‡∏î/‡∏õ)</th>
              <th class="p-3 text-center">‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà</th>
              <th class="p-3 text-center">‡∏ï‡∏±‡∏î‡∏≠‡∏≠‡∏Å (Used)</th>
            </tr>
          </thead>
          <tbody id="stockBody" class="divide-y"></tbody>
        </table>
      </div>
    </div>

    <div class="mt-8 pt-4 border-t">
      <div class="flex items-center justify-between mb-2">
        <h3 class="font-semibold text-green-700">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà (‡πÉ‡∏™‡πà‡∏Ñ‡∏∑‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á)</h3>
      </div>
       
      <div class="bg-green-50 p-4 rounded-lg border border-green-100">
        <label class="block text-sm mb-1 font-medium text-green-800">‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ (EXP)</label>
        
        <div class="grid grid-cols-4 gap-2 mb-3">
            <select id="inputD" class="border rounded p-2 bg-white col-span-1 text-center"></select>
            <select id="inputM" class="border rounded p-2 bg-white col-span-1 text-center"></select>
            <input id="inputY" type="number" class="border rounded p-2 text-center col-span-1" placeholder="‡∏õ‡∏µ" >
            <select id="inputType" class="border rounded p-2 bg-white col-span-1 text-center font-medium text-blue-700">
                <option value="BE">‡∏û.‡∏®.</option>
                <option value="AD">‡∏Ñ.‡∏®.</option>
            </select>
        </div>
        
        <div class="flex gap-3 items-end">
            <div class="w-1/2">
                <label class="block text-sm mb-1 font-medium text-green-800">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡∏¥‡∏°</label>
                <input type="number" id="addQty" min="0" step="1" class="border rounded px-3 py-2 w-full" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô">
            </div>
            <button id="addNewBtn" class="btn primary bg-green-600 border-green-600 w-1/2">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
        </div>

        <div id="newList" class="mt-3 space-y-2"></div>
        <div id="newEmpty" class="text-center text-xs text-slate-400 mt-2 p-2 border border-dashed rounded bg-white/50">‚Äî ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà ‚Äî</div>
      </div>
    </div>

    <div class="mt-8">
      <button id="submitBtn" class="btn primary w-full text-lg py-3 shadow-lg shadow-blue-200">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
      <div id="saveMsg" class="text-center mt-2 text-sm text-slate-500 min-h-[20px]"></div>
    </div>
  </section>

  <section id="view-output" class="card p-4 hidden">
    <div class="flex items-center justify-between mb-3 border-b pb-3">
      <h2 class="text-xl font-semibold">‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</h2>
      <div class="flex items-center gap-2">
        <select id="boxViewSelect" class="border rounded px-2 py-1 text-sm bg-slate-50"></select>
        <button id="refreshNearBtn" class="btn text-sm">‚Üª</button>
      </div>
    </div>
    <div class="mb-2 flex items-center gap-2 text-sm justify-end">
        <span class="muted">‡∏î‡∏π‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á(‡∏ß‡∏±‡∏ô):</span>
        <input id="nearDays" type="number" value="1000" class="border rounded px-2 py-1 w-20 text-center">
    </div>
    <div id="nearList" class="space-y-3"></div>
  </section>
</div>

<div id="qrModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl p-6 w-full max-w-sm text-center shadow-2xl">
      <h3 class="text-lg font-semibold mb-3">QR Code ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ</h3>
      <div id="qrBox" class="mb-4 flex justify-center p-2 bg-white"></div>
      <input id="qrLink" class="border rounded px-3 py-2 w-full text-xs mb-3 text-slate-500 bg-slate-100" readonly>
      <div class="flex justify-center gap-2">
        <button id="qrCopy" class="btn text-sm">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å</button>
        <button id="qrClose" class="btn text-sm">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
</div>

<div id="successModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl p-6 w-full max-w-md shadow-2xl animate-bounce-in">
        <div class="text-center mb-4">
            <div class="mx-auto w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center text-3xl mb-3">‚úì</div>
            <h3 class="text-2xl font-bold text-slate-800">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h3>
            <p class="text-slate-500 text-sm">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Sheet ‡πÅ‡∏•‡πâ‡∏ß</p>
        </div>
        
        <div class="bg-amber-50 border border-amber-200 rounded-xl p-4 mb-4 text-left">
            <div class="flex items-center gap-2 mb-2 text-amber-800 font-bold border-b border-amber-200 pb-1">
                <span>‚ö†Ô∏è ‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ</span>
            </div>
            <div id="modalWarnContent" class="text-sm space-y-1 text-slate-700">
                </div>
        </div>

        <button onclick="closeSuccessModal()" class="w-full btn primary py-3 text-lg">‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö / ‡∏õ‡∏¥‡∏î</button>
    </div>
</div>

<div id="modalNeedAdd" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-xl p-5 w-full max-w-lg shadow-xl">
    <h3 class="text-lg font-bold text-red-600 mb-2">‚ùå ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠</h3>
    <div id="modalNeedAddMsg" class="text-slate-700 mb-4 text-sm leading-relaxed"></div>
    <div class="flex justify-end gap-2">
      <button onclick="document.getElementById('modalNeedAdd').classList.add('hidden')" class="btn">‡∏õ‡∏¥‡∏î</button>
    </div>
  </div>
</div>

<script>
// ===== CONFIG =====
const API_BASE = 'https://script.google.com/macros/s/AKfycbyyTKnYTnI-mq6LZ7kqMNS0XZL1LGcEU1PIueUfbuHnbNYeOn_eWM0izZvkFb7DhvE8/exec'; // **‡πÉ‡∏™‡πà Link API ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà**

// ===== STATE =====
let currentBox = localStorage.getItem('em_box') || '';
let currentLots = [];
let useInputs   = {}; 
let newLotsPend = [];

// ===== Helpers : Date & Format =====
function initDateSelectors(){
    const dSel = document.getElementById('inputD');
    for(let i=1; i<=31; i++){
        const o=document.createElement('option'); o.value=i; o.text=i; dSel.appendChild(o);
    }
    const mSel = document.getElementById('inputM');
    const thMonth = ['‡∏°.‡∏Ñ.','‡∏Å.‡∏û.','‡∏°‡∏µ.‡∏Ñ.','‡πÄ‡∏°.‡∏¢.','‡∏û.‡∏Ñ.','‡∏°‡∏¥.‡∏¢.','‡∏Å.‡∏Ñ.','‡∏™.‡∏Ñ.','‡∏Å.‡∏¢.','‡∏ï.‡∏Ñ.','‡∏û.‡∏¢.','‡∏ò.‡∏Ñ.'];
    thMonth.forEach((m,i)=>{
        const o=document.createElement('option'); o.value=i+1; o.text=m; mSel.appendChild(o);
    });
    const now = new Date();
    dSel.value = now.getDate();
    mSel.value = now.getMonth()+1;
    document.getElementById('inputY').value = now.getFullYear() + 543; // Default ‡πÄ‡∏õ‡πá‡∏ô ‡∏û.‡∏®.
    document.getElementById('inputType').value = 'BE';
}

function getInputDateISO(){
    const d = document.getElementById('inputD').value.padStart(2,'0');
    const m = document.getElementById('inputM').value.padStart(2,'0');
    let y = parseInt(document.getElementById('inputY').value) || 0;
    const type = document.getElementById('inputType').value;
    
    if(y === 0) return '';
    if(type === 'BE') y = y - 543; 
    
    return `${y}-${m}-${d}`;
}

function formatThaiDate(isoStr){
    if(!isoStr) return '-';
    try{
        const [y,m,d] = isoStr.split('-');
        const thMonth = ['‡∏°.‡∏Ñ.','‡∏Å.‡∏û.','‡∏°‡∏µ.‡∏Ñ.','‡πÄ‡∏°.‡∏¢.','‡∏û.‡∏Ñ.','‡∏°‡∏¥.‡∏¢.','‡∏Å.‡∏Ñ.','‡∏™.‡∏Ñ.','‡∏Å.‡∏¢.','‡∏ï.‡∏Ñ.','‡∏û.‡∏¢.','‡∏ò.‡∏Ñ.'];
        const yearThai = parseInt(y) + 543;
        return `${parseInt(d)} ${thMonth[parseInt(m)-1]} ${yearThai}`;
    }catch(e){ return isoStr; }
}

function setBoxBadge(){ const el=document.getElementById('boxBadge'); if(currentBox){ el.textContent='‡∏Å‡∏•‡πà‡∏≠‡∏á: '+currentBox; el.classList.remove('hidden'); } else { el.classList.add('hidden'); } }
function switchView(id){ ['view-form','view-output'].forEach(v=>{document.getElementById(v).classList.add('hidden');}); document.getElementById(id).classList.remove('hidden'); }
function toast(el,msg){ el.textContent = msg; setTimeout(()=> el.textContent='', 3000); }

async function apiGet(p){
  const url = API_BASE + '?' + new URLSearchParams(p).toString();
  const r = await fetch(url, { cache:'no-store' });
  const txt = await r.text();
  try { hideApiBanner(); return JSON.parse(txt); }
  catch { showApiBanner('‚ö†Ô∏è ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ'); return {}; }
}
async function apiPost(payload){
  const r = await fetch(API_BASE,{ method:'POST', headers:{'Content-Type':'text/plain; charset=UTF-8'}, body: JSON.stringify(payload) });
  return r.json();
}
function showApiBanner(msg){ const b=document.getElementById('apiBanner'); b.textContent=msg; b.style.display='block'; }
function hideApiBanner(){ const b=document.getElementById('apiBanner'); b.style.display='none'; b.textContent=''; }

// ===== Logic =====
async function loadBoxes(){
  const data = await apiGet({action:'boxes'});
  const boxes = data.boxes && data.boxes.length ? data.boxes : ['Box-1','Box-2'];

  const selForm = document.getElementById('boxSelect'); selForm.innerHTML = '';
  const selView = document.getElementById('boxViewSelect'); selView.innerHTML = '';
   
  boxes.forEach(b=>{
    selForm.add(new Option(b,b));
    selView.add(new Option(b,b));
  });

  if(currentBox && boxes.includes(currentBox)){
      selForm.value=currentBox; selView.value=currentBox;
  } else {
      currentBox = boxes[0]; selForm.value=currentBox; localStorage.setItem('em_box',currentBox);
  }
  setBoxBadge();
  await loadItems(); await loadLots();
}

async function loadItems(){
  if(!currentBox) return;
  useInputs={}; newLotsPend=[]; renderNewList();
  const data = await apiGet({action:'items', box: currentBox});
  const sel = document.getElementById('drugSelect'); sel.innerHTML='';
  sel.add(new Option('- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤ -',''));
  (data.items||[]).forEach(n=>{ sel.add(new Option(n,n)); });
}

function makeStepper(expISO, maxQty){
  const wrap=document.createElement('div'); wrap.className='stepper justify-center';
  const minus=document.createElement('button'); minus.textContent='‚àí';
  const input=document.createElement('input'); input.type='number'; input.min='0'; input.max=String(maxQty); input.value=String(useInputs[expISO]||0);
   
  const clamp=()=>{ 
      let v=parseInt(input.value)||0; if(v<0)v=0; if(v>maxQty)v=maxQty; 
      input.value=String(v); useInputs[expISO]=v; 
  };
  minus.onclick=(e)=>{ e.preventDefault(); input.value=String(Math.max(0,(parseInt(input.value)||0)-1)); clamp(); };
  const plus=document.createElement('button'); plus.textContent='+';
  plus.onclick =(e)=>{ e.preventDefault(); input.value=String(Math.min(maxQty,(parseInt(input.value)||0)+1)); clamp(); };
  input.onchange = clamp;
  wrap.append(minus,input,plus);
  return wrap;
}

function renderStockTable(){
  const tb=document.getElementById('stockBody'); tb.innerHTML='';
  if(!currentLots.length){
    tb.innerHTML = `<tr><td colspan="3" class="p-4 text-center text-slate-400">‚úÖ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏¢‡∏≤‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏´‡∏£‡∏∑‡∏≠ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏¢‡∏≤</td></tr>`;
    return;
  }
  currentLots.forEach(l=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td class="p-3 text-sm text-slate-700">${formatThaiDate(l.expISO)}</td>
                    <td class="p-3 text-center font-medium">${l.qty}</td>`;
     
    const tdStep = document.createElement('td'); tdStep.className='p-2';
    tdStep.appendChild(makeStepper(l.expISO, l.qty));
    tr.appendChild(tdStep);
    tb.appendChild(tr);
  });
}

async function loadLots(){
  const drug = document.getElementById('drugSelect').value.trim();
  useInputs={}; newLotsPend=[]; renderNewList();
  if(!currentBox || !drug){ currentLots=[]; renderStockTable(); return; }
  const data = await apiGet({action:'lots', box: currentBox, drug});
  currentLots = data.lots || [];
  renderStockTable();
}

function addNewLot(){
  const expISO = getInputDateISO();
  const qty = parseInt(document.getElementById('addQty').value)||0;
   
  if(!expISO || expISO.length < 10){ alert('‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'); return; }
  if(qty<=0){ alert('‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô'); return; }
   
  newLotsPend.push({exp: expISO, qty}); 
  renderNewList();
  document.getElementById('addQty').value='';
}

function renderNewList(){
  const wrap=document.getElementById('newList'); const empty=document.getElementById('newEmpty'); wrap.innerHTML='';
  if(!newLotsPend.length){ empty.classList.remove('hidden'); return; }
  empty.classList.add('hidden');
   
  newLotsPend.forEach((n,idx)=>{ 
      const row=document.createElement('div'); 
      row.className='flex items-center justify-between p-2 border rounded bg-white shadow-sm'; 
      row.innerHTML=`<div class="text-sm"><span class="font-bold text-green-700">‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà:</span> ${formatThaiDate(n.exp)} <span class="mx-2 text-slate-300">|</span> ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: <b>${n.qty}</b></div>`; 
      const del=document.createElement('button'); del.className='text-red-500 hover:text-red-700 text-sm px-2'; del.textContent='‡∏•‡∏ö'; 
      del.onclick=()=>{ newLotsPend.splice(idx,1); renderNewList(); }; 
      row.appendChild(del); wrap.appendChild(row); 
  });
}

async function submitData(){
  const btn = document.getElementById('submitBtn');
  const msg = document.getElementById('saveMsg');
  const dateVisit = document.getElementById('dateVisit').value || new Date().toISOString().slice(0,10);
  const inspector = document.getElementById('inspector').value;
  const reason = getReason();
  const drug = document.getElementById('drugSelect').value;

  if(!currentBox) return alert('‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡πà‡∏≠‡∏á');
  if(!drug) return alert('‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏¢‡∏≤');
  if(!reason) return alert('‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•');

  const usedLots = Object.entries(useInputs).filter(([_,q])=>q>0).map(([exp,qty])=>({exp, qtyUsed:qty}));
  const stockMap={}; currentLots.forEach(l=>{ stockMap[l.expISO]=(stockMap[l.expISO]||0)+Number(l.qty); });
  const addMap={}; newLotsPend.forEach(n=>{ addMap[n.exp]=(addMap[n.exp]||0)+Number(n.qty); });
  let errorHtml = '';
  usedLots.forEach(u=>{
      const have = (stockMap[u.exp]||0) + (addMap[u.exp]||0);
      if(u.qtyUsed > have) errorHtml += `<li>Exp ${formatThaiDate(u.exp)}: ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ${u.qtyUsed} ‡πÅ‡∏ï‡πà‡∏°‡∏µ ${have}</li>`;
  });
  if(errorHtml){
      document.getElementById('modalNeedAddMsg').innerHTML = `<ul class="list-disc pl-5 space-y-1">${errorHtml}</ul>`;
      document.getElementById('modalNeedAdd').classList.remove('hidden');
      return;
  }

  // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
  btn.disabled = true; btn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
  try{
      const res = await apiPost({ box:currentBox, dateVisit, drug, reason, inspector, usedLots, newLots:newLotsPend });
      
      if(res.ok){
          useInputs={}; newLotsPend=[]; renderNewList(); await loadLots();
          showSuccessModal(res.nearest); 
      } else {
          toast(msg, 'Error: '+res.error);
      }
  }catch(e){
      toast(msg, 'Connection Failed: ' + e);
  }
  btn.disabled = false; btn.textContent = '‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
}

function showSuccessModal(item){
    const content = document.getElementById('modalWarnContent');
    if(item){
        content.innerHTML = `
            <div class="font-bold text-lg text-slate-800">${item.drug}</div>
            <div>‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏: <span class="text-red-600 font-bold">${formatThaiDate(item.expISO)}</span></div>
            <div class="text-slate-500 text-xs">‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏µ‡∏Å ${item.days} ‡∏ß‡∏±‡∏ô</div>
        `;
    } else {
        content.innerHTML = `<div class="text-green-600">‚úÖ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÉ‡∏ô‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ</div>`;
    }
    document.getElementById('successModal').classList.remove('hidden');
}

function closeSuccessModal(){
    document.getElementById('successModal').classList.add('hidden');
}

function getReason(){
    const r = document.querySelector('input[name="reason"]:checked');
    if(!r) return '';
    if(r.value==='‡∏≠‡∏∑‡πà‡∏ô‡πÜ') return document.getElementById('reasonOther').value.trim();
    return r.value;
}

// ===== View Output =====
async function loadNear(){
  if(!currentBox) return;
  const days = Number(document.getElementById('nearDays').value)||1000;
  const list = document.getElementById('nearList'); 
  list.innerHTML = '<div class="text-center p-4 text-slate-400">Loading...</div>';
   
  const data = await apiGet({action:'near', box: currentBox, days});
  list.innerHTML='';
   
  if(!data.rows || !data.rows.length){
      list.innerHTML='<div class="text-center p-5 border rounded bg-slate-50">‚úÖ ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏°‡∏≤‡∏Å! ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏¢‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ</div>';
      return;
  }
   
  data.rows.forEach((r,idx)=>{
      const isUrgent = r.days < 90; 
      const el=document.createElement('div');
      el.className=`p-3 border rounded-lg flex items-center justify-between bg-white shadow-sm ${idx===0 ? 'ring-2 ring-amber-300' : ''}`;
      el.innerHTML=`
      <div>
        <div class="flex items-center gap-2 mb-1">
           ${idx===0 ? '<span class="badge-nearest">‡πÉ‡∏Å‡∏•‡πâ‡∏™‡∏∏‡∏î!</span>' : ''}
           <span class="font-bold text-slate-700">${r.drug}</span>
        </div>
        <div class="text-sm ${isUrgent?'text-red-600 font-medium':'text-slate-500'}">
           EXP: ${formatThaiDate(r.expISO)} (${r.days} ‡∏ß‡∏±‡∏ô)
        </div>
      </div>
      <div class="text-right bg-slate-100 px-3 py-1 rounded">
         <div class="text-xs text-slate-500">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div>
         <div class="font-bold text-lg">${r.qty}</div>
      </div>
      `;
      list.appendChild(el);
  });
}

// ===== Init =====
window.addEventListener('DOMContentLoaded', ()=>{
    initDateSelectors();
    document.getElementById('dateVisit').value = new Date().toISOString().slice(0,10);
    
    document.querySelectorAll('input[name="reason"]').forEach(r=>{
        r.addEventListener('change', (e)=>{
            const txt = document.getElementById('reasonOther');
            if(e.target.value==='‡∏≠‡∏∑‡πà‡∏ô‡πÜ') txt.classList.remove('hidden');
            else txt.classList.add('hidden');
        });
    });

    loadBoxes();
    document.getElementById('tab-form').onclick=()=>switchView('view-form');
    document.getElementById('tab-view').onclick=()=>{ switchView('view-output'); loadNear(); };
    
    document.getElementById('boxSelect').onchange=(e)=>{ currentBox=e.target.value; localStorage.setItem('em_box',currentBox); setBoxBadge(); loadItems(); loadLots(); };
    document.getElementById('boxViewSelect').onchange=(e)=>{ currentBox=e.target.value; localStorage.setItem('em_box',currentBox); setBoxBadge(); loadNear(); };
    document.getElementById('drugSelect').onchange=loadLots;
    document.getElementById('addNewBtn').onclick=addNewLot;
    document.getElementById('submitBtn').onclick=submitData;
    document.getElementById('refreshNearBtn').onclick=loadNear;
    
    document.getElementById('qrBtn').onclick = ()=>{
      const url = window.location.href.split('?')[0]; 
      const appUrl = url + '?view=select';
      document.getElementById('qrBox').innerHTML='';
      new QRCode(document.getElementById('qrBox'),{text:appUrl,width:180,height:180});
      document.getElementById('qrLink').value=appUrl;
      document.getElementById('qrModal').classList.remove('hidden');
    };
    document.getElementById('qrClose').onclick=()=>document.getElementById('qrModal').classList.add('hidden');
    document.getElementById('qrCopy').onclick=()=>{
        navigator.clipboard.writeText(document.getElementById('qrLink').value);
        alert('Copied!');
    };
});
</script>
</body>
</html>

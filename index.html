<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Emergency Med Box</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 4px 16px rgba(0,0,0,.05)}
    .chip{background:#f1f5f9;border:1px solid #e2e8f0;border-radius:9999px;padding:.25rem .5rem;font-size:.75rem}
    .muted{color:#64748b}
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
<div class="max-w-5xl mx-auto p-4 md:p-6">
  <header class="flex items-center justify-between mb-4">
    <h1 class="text-2xl font-bold">ระบบตรวจเช็คยาในกล่องยาฉุกเฉิน</h1>
    <div id="boxBadge" class="chip hidden"></div>
  </header>

  <div class="grid md:grid-cols-3 gap-4 mb-4">
    <button id="tab-select" class="px-4 py-2 card text-left">หน้า 1: เลือกกล่องยา</button>
    <button id="tab-form" class="px-4 py-2 card text-left">หน้า 2: ลงข้อมูล</button>
    <button id="tab-view" class="px-4 py-2 card text-left">หน้าแสดงผล</button>
  </div>

  <section id="view-select" class="card p-4">
    <h2 class="text-xl font-semibold mb-3">เลือกกล่องยา</h2>
    <p class="muted mb-3">ตัวอย่าง: IPD01, ER01, ER02, ER03</p>
    <div class="flex gap-2 flex-wrap mb-4" id="boxBtns"></div>
    <div class="flex items-center gap-2">
      <input id="boxInput" class="border rounded px-3 py-2 w-48" placeholder="หรือพิมพ์เอง เช่น ER03">
      <button id="boxSetBtn" class="px-4 py-2 rounded bg-blue-600 text-white">เลือกกล่องนี้</button>
      <button id="boxClearBtn" class="px-3 py-2 rounded bg-slate-200">ล้าง</button>
    </div>
  </section>

  <section id="view-form" class="card p-4 hidden">
    <h2 class="text-xl font-semibold mb-4">ลงข้อมูล (เขียนเข้า Google Sheet)</h2>
    <div class="grid md:grid-cols-2 gap-4">
      <div>
        <label class="block text-sm mb-1">วันที่มาที่ห้องยา</label>
        <input type="date" id="dateVisit" class="border rounded px-3 py-2 w-full">
      </div>
      <div>
        <label class="block text-sm mb-1">ผู้ตรวจสอบ</label>
        <select id="inspector" class="border rounded px-3 py-2 w-full">
          <option value="">- เลือก -</option>
          <option>A</option>
          <option>B</option>
          <option>C</option>
        </select>
      </div>
      <div>
        <label class="block text-sm mb-1">รายการยาที่ใช้ (เลือกจากสต็อกในกล่อง)</label>
        <div class="flex gap-2">
          <select id="drugSelect" class="border rounded px-3 py-2 w-full"></select>
          <input id="drugCustom" class="border rounded px-3 py-2 w-1/2" placeholder="หรือพิมพ์ชื่อยาใหม่">
        </div>
      </div>
      <div>
        <label class="block text-sm mb-1">เหตุผลที่ใช้</label>
        <div class="flex gap-4 items-center">
          <label class="inline-flex items-center gap-2"><input type="radio" name="reason" value="ยาใกล้ EXP"> ยาใกล้ EXP</label>
          <label class="inline-flex items-center gap-2"><input type="radio" name="reason" value="ใช้ยาในกล่อง"> ใช้ยาในกล่อง</label>
        </div>
      </div>
    </div>

    <div class="mt-6">
      <h3 class="font-semibold mb-2">ยาที่ใช้ไป (เลือกล็อต/วันหมดอายุที่จะหักสต็อก หรือกดลบล็อตเดิม)</h3>
      <p class="muted mb-3">หลังเลือกยา ให้กดปุ่ม “โหลดล็อตจากสต็อก” เพื่อตรวจสอบล็อตที่มีอยู่</p>
      <div class="flex gap-2 mb-3">
        <button id="loadLotsBtn" class="px-3 py-2 rounded bg-slate-200">โหลดล็อตจากสต็อก</button>
        <button id="clearLotsBtn" class="px-3 py-2 rounded bg-slate-200">ล้างรายการ</button>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full border" id="usedLotsTable">
          <thead class="bg-slate-100">
            <tr>
              <th class="p-2 border">EXP</th>
              <th class="p-2 border">จำนวนคงเหลือ</th>
              <th class="p-2 border">ใช้ไป</th>
              <th class="p-2 border">ลบล็อตนี้</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="mt-6">
      <h3 class="font-semibold mb-2">เพิ่มล็อตใหม่ (กรณีใส่ยาเข้าไปใหม่)</h3>
      <button id="addNewLotBtn" class="px-3 py-2 rounded bg-green-600 text-white mb-3">+ เพิ่มแถวล็อตใหม่</button>
      <div id="newLots" class="space-y-2"></div>
    </div>

    <div class="mt-6 flex gap-2">
      <button id="submitBtn" class="px-4 py-2 rounded bg-blue-600 text-white">บันทึก</button>
      <div id="saveMsg" class="muted"></div>
    </div>
  </section>

  <section id="view-output" class="card p-4 hidden">
    <div class="flex items-center justify-between mb-2">
      <h2 class="text-xl font-semibold">สรุปและยาใกล้หมดอายุ</h2>
      <div>
        <label class="mr-2 muted">ภายใน (วัน)</label>
        <input id="nearDays" type="number" min="1" value="90" class="border rounded px-3 py-1 w-24">
        <button id="refreshNearBtn" class="ml-2 px-3 py-1 rounded bg-slate-200">รีเฟรช</button>
      </div>
    </div>
    <div id="nearList" class="space-y-2"></div>
  </section>
</div>

<script>
// ==== CONFIG ====
const API_BASE = 'YOUR_WEB_APP_URL'; // <— ใส่ URL จาก Apps Script Deploy

// ==== State ====
let currentBox = localStorage.getItem('em_box') || '';

function setBoxBadge() {
  const el = document.getElementById('boxBadge');
  if (currentBox) {
    el.textContent = 'กล่อง: ' + currentBox;
    el.classList.remove('hidden');
  } else {
    el.classList.add('hidden');
  }
}

function switchView(id) {
  ['view-select','view-form','view-output'].forEach(v=>{
    document.getElementById(v).classList.add('hidden');
  });
  document.getElementById(id).classList.remove('hidden');
}

function toast(el, msg) { el.textContent = msg; setTimeout(()=> el.textContent = '', 3000); }

async function apiGet(params) {
  const url = API_BASE + '?' + new URLSearchParams(params).toString();
  const res = await fetch(url, { method: 'GET' });
  return res.json();
}

async function apiPost(payload) {
  const res = await fetch(API_BASE, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload),
  });
  return res.json();
}

// ==== Populate boxes ====
async function loadBoxes() {
  try {
    const data = await apiGet({ action: 'boxes' });
    const btns = document.getElementById('boxBtns');
    btns.innerHTML = '';
    (data.boxes || ['IPD01','ER01','ER02','ER03']).forEach(b=>{
      const btn = document.createElement('button');
      btn.className = 'px-3 py-2 rounded bg-slate-200';
      btn.textContent = b;
      btn.onclick = ()=>{ currentBox = b; localStorage.setItem('em_box', b); setBoxBadge(); loadItems(); loadNear(); switchView('view-form'); };
      btns.appendChild(btn);
    });
  } catch {}
}

// ==== Items / Lots ====
async function loadItems() {
  if (!currentBox) return;
  const data = await apiGet({ action: 'items', box: currentBox });
  const sel = document.getElementById('drugSelect');
  sel.innerHTML = '';
  const opt0 = document.createElement('option'); opt0.value=''; opt0.textContent='- เลือกยา -'; sel.appendChild(opt0);
  (data.items||[]).forEach(n=>{
    const opt = document.createElement('option'); opt.value = n; opt.textContent = n; sel.appendChild(opt);
  });
}

async function loadLots() {
  const drug = getDrugName();
  if (!currentBox || !drug) return;
  const data = await apiGet({ action: 'lots', box: currentBox, drug });
  const tbody = document.querySelector('#usedLotsTable tbody');
  tbody.innerHTML = '';
  (data.lots||[]).forEach(l=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="border p-2">${l.expISO}</td>
      <td class="border p-2 text-right">${l.qty}</td>
      <td class="border p-2"><input type="number" min="0" max="${l.qty}" step="1" class="border rounded px-2 py-1 w-24" data-exp="${l.expISO}" value="0"></td>
      <td class="border p-2 text-center"><input type="checkbox" data-del="${l.expISO}"></td>
    `;
    tbody.appendChild(tr);
  });
}

function clearLots() {
  document.querySelector('#usedLotsTable tbody').innerHTML = '';
}

function addNewLotRow() {
  const wrap = document.getElementById('newLots');
  const idx = wrap.children.length;
  const row = document.createElement('div');
  row.className = 'grid md:grid-cols-3 gap-2';
  row.innerHTML = `
    <div><label class="block text-sm mb-1">EXP ใหม่</label><input type="date" class="border rounded px-3 py-2 w-full" data-type="exp"></div>
    <div><label class="block text-sm mb-1">จำนวน</label><input type="number" min="0" step="1" class="border rounded px-3 py-2 w-full" data-type="qty" placeholder="เช่น 2"></div>
    <div class="flex items-end"><button class="px-3 py-2 rounded bg-slate-200" onclick="this.closest('div.grid').remove()">ลบแถว</button></div>
  `;
  wrap.appendChild(row);
}

function getDrugName() {
  const sel = document.getElementById('drugSelect').value.trim();
  const custom = document.getElementById('drugCustom').value.trim();
  return custom || sel;
}

async function submitData() {
  const msg = document.getElementById('saveMsg');
  const dateVisit = document.getElementById('dateVisit').value || new Date().toISOString().slice(0,10);
  const inspector = document.getElementById('inspector').value || '';
  const reason = (document.querySelector('input[name="reason"]:checked')||{}).value || '';
  const drug = getDrugName();
  if (!currentBox) { toast(msg, 'ยังไม่ได้เลือกกล่อง'); return; }
  if (!drug) { toast(msg, 'โปรดเลือก/พิมพ์ชื่อยา'); return; }

  // used lots
  const usedLots = [];
  document.querySelectorAll('#usedLotsTable tbody tr').forEach(tr=>{
    const qtyUsed = Number(tr.querySelector('input[type="number"]').value)||0;
    const exp = tr.querySelector('input[type="number"]').dataset.exp;
    const del = tr.querySelector('input[type="checkbox"]').checked;
    if (qtyUsed > 0 || del) {
      usedLots.push({ exp, qtyUsed, delete: del });
    }
  });

  // new lots
  const newLots = [];
  document.querySelectorAll('#newLots [data-type="exp"]').forEach(expEl=>{
    const qtyEl = expEl.closest('.grid').querySelector('[data-type="qty"]');
    const exp = expEl.value; const qty = Number(qtyEl.value)||0;
    if (exp && qty > 0) newLots.push({ exp, qty });
  });

  try {
    const res = await apiPost({ box: currentBox, dateVisit, drug, reason, inspector, usedLots, newLots });
    if (res.ok) {
      toast(msg, 'บันทึกแล้ว');
      loadItems(); loadLots(); loadNear();
      document.getElementById('newLots').innerHTML = '';
    } else {
      toast(msg, 'ผิดพลาด: ' + res.error);
    }
  } catch (e) {
    toast(msg, 'เชื่อมต่อไม่ได้');
  }
}

// ==== Near expiry view ====
async function loadNear() {
  if (!currentBox) return;
  const days = Number(document.getElementById('nearDays').value)||90;
  const data = await apiGet({ action: 'near', box: currentBox, days });
  const list = document.getElementById('nearList');
  list.innerHTML = '';
  const title = document.createElement('div');
  title.className = 'mb-2 muted';
  title.textContent = `กล่อง: ${currentBox} — ยาที่หมดภายใน ${data.days} วัน`;
  list.appendChild(title);
  (data.rows||[]).forEach(r=>{
    const el = document.createElement('div');
    el.className = 'p-3 border rounded flex items-center justify-between';
    el.innerHTML = `<div><div class="font-medium">${r.drug}</div><div class="muted">EXP: ${r.expISO}</div></div><div class="text-right">Qty: ${r.qty}</div>`;
    list.appendChild(el);
  });
  if (!data.rows || !data.rows.length) {
    const empty = document.createElement('div');
    empty.className = 'muted';
    empty.textContent = '— ไม่มีรายการใกล้หมดอายุในช่วงที่กำหนด —';
    list.appendChild(empty);
  }
}

// ==== Events ====
window.addEventListener('DOMContentLoaded', ()=>{
  setBoxBadge();
  document.getElementById('dateVisit').value = new Date().toISOString().slice(0,10);
  loadBoxes();

  document.getElementById('tab-select').onclick = ()=> switchView('view-select');
  document.getElementById('tab-form').onclick = ()=> { if (!currentBox) { switchView('view-select'); } else { switchView('view-form'); } };
  document.getElementById('tab-view').onclick = ()=> { if (!currentBox) { switchView('view-select'); } else { switchView('view-output'); loadNear(); } };

  document.getElementById('boxSetBtn').onclick = ()=>{
    const v = document.getElementById('boxInput').value.trim();
    if (v) { currentBox = v; localStorage.setItem('em_box', v); setBoxBadge(); loadItems(); loadNear(); switchView('view-form'); }
  };
  document.getElementById('boxClearBtn').onclick = ()=>{ localStorage.removeItem('em_box'); currentBox=''; setBoxBadge(); switchView('view-select'); };

  document.getElementById('loadLotsBtn').onclick = loadLots;
  document.getElementById('clearLotsBtn').onclick = clearLots;
  document.getElementById('addNewLotBtn').onclick = addNewLotRow;
  document.getElementById('submitBtn').onclick = submitData;
  document.getElementById('refreshNearBtn').onclick = loadNear;
});
</script>
</body>
</html>

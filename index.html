<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Emergency Med Box</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    /* Styling card, button, etc. */
    .card { background: #fff; border: 1px solid #e5e7eb; border-radius:16px; box-shadow: 0 4px 16px rgba(0,0,0,.05); }
    .btn { border-radius: .5rem; padding: .5rem .9rem; border: 1px solid #e5e7eb; background: #f8fafc; }
    .btn.primary { background: #2563eb; color: #fff; border-color: #2563eb; }
    .muted { color: #64748b; }
    .chip { background: #eef2ff; border:1px solid #c7d2fe; border-radius:9999px; padding:.25rem .6rem; font-size:.75rem; }
    thead th { background: #f1f5f9; }
    .stepper { display:flex; align-items:center; gap:.25rem; }
    .stepper button { width:32px; height:32px; border:1px solid #e5e7eb; border-radius:.5rem; background:#fff; }
    .stepper input { width:72px; text-align:center; border:1px solid #e5e7eb; border-radius:.5rem; padding:.35rem; }
    #apiBanner { display:none; }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">

  <div class="max-w-5xl mx-auto p-4 md:p-6">
    <div id="apiBanner" class="mb-3 rounded-lg border border-amber-300 bg-amber-50 text-amber-800 px-3 py-2 text-sm"></div>
    <header class="flex items-center justify-between mb-4">
      <div class="flex items-center gap-2">
        <h1 class="text-2xl font-bold">‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Ñ‡∏¢‡∏≤‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏¢‡∏≤‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</h1>
        <span id="boxBadge" class="chip hidden"></span>
      </div>
      <button id="qrBtn" class="btn">QR</button>
    </header>

    <!-- Tabs -->
    <div class="grid md:grid-cols-3 gap-3 mb-4">
      <button id="tab-select" class="btn card text-left">‡∏´‡∏ô‡πâ‡∏≤ 1: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏¢‡∏≤</button>
      <button id="tab-form" class="btn card text-left">‡∏´‡∏ô‡πâ‡∏≤ 2: ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
      <button id="tab-view" class="btn card text-left">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•</button>
    </div>

    <!-- Page: Select Box -->
    <section id="view-select" class="card p-4">
      <h2 class="text-xl font-semibold mb-3">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏¢‡∏≤</h2>
      <div id="boxBtns" class="flex gap-2 flex-wrap mb-4"></div>
      <div class="flex items-center gap-2">
        <input id="boxInput" class="border rounded px-3 py-2 w-48" placeholder="‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏á ‡πÄ‡∏ä‡πà‡∏ô ER03">
        <button id="boxSetBtn" class="btn primary">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ</button>
        <button id="boxClearBtn" class="btn">‡∏•‡πâ‡∏≤‡∏á</button>
      </div>
    </section>

    <!-- Page: Input Form -->
    <section id="view-form" class="card p-4 hidden">
      <h2 class="text-xl font-semibold mb-4">‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤ Google Sheet)</h2>
      <div class="grid md:grid-cols-2 gap-3 mb-4">
        <div class="p-4 border rounded-lg bg-white">
          <div class="text-sm muted mb-1">‡∏¢‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</div>
          <div id="dashSoonest" class="text-base">‚Äî ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚Äî</div>
        </div>
        <div class="p-4 border rounded-lg bg-white">
          <div class="text-sm muted mb-1">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ô‡∏≥‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏°‡∏≤‡∏ó‡∏µ‡πà‡∏´‡πâ‡∏≠‡∏á‡∏¢‡∏≤</div>
          <div id="dashVisits" class="text-base">‚Äî ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚Äî</div>
        </div>
      </div>
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏ó‡∏µ‡πà‡∏´‡πâ‡∏≠‡∏á‡∏¢‡∏≤</label>
          <input type="date" id="dateVisit" class="border rounded px-3 py-2 w-full">
        </div>
        <div>
          <label class="block text-sm mb-1">‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</label>
          <select id="inspector" class="border rounded px-3 py-2 w-full">
            <option value="">- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å -</option>
            <option>‡∏†‡∏ç.‡∏û‡∏ô‡∏≤‡∏£‡∏±‡∏ï‡∏ô‡πå</option>
            <option>‡∏†‡∏ç.‡∏û‡∏±‡∏ä‡∏£‡∏µ‡∏ß‡∏£‡∏£‡∏ì</option>
            <option>‡∏†‡∏Å.‡∏≠‡∏ô‡∏∏‡∏û‡∏á‡∏®‡πå</option>
            <option>‡∏†‡∏ç.‡∏≠‡∏†‡∏¥‡∏ç‡∏ç‡∏≤</option>
            <option>‡∏†‡∏ç.‡∏™‡∏∏‡∏£‡∏µ‡∏ß‡∏±‡∏í‡∏ô‡πå</option>
          </select>
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm mb-1">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ</label>
          <div class="flex flex-wrap items-center gap-4">
            <label class="inline-flex items-center gap-2"><input type="radio" name="reason" value="‡∏¢‡∏≤‡πÉ‡∏Å‡∏•‡πâ EXP"> ‡∏¢‡∏≤‡πÉ‡∏Å‡∏•‡πâ EXP</label>
            <label class="inline-flex items-center gap-2"><input type="radio" name="reason" value="‡πÉ‡∏ä‡πâ‡∏¢‡∏≤‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á" checked> ‡πÉ‡∏ä‡πâ‡∏¢‡∏≤‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á</label>
            <label class="inline-flex items-center gap-2"><input type="radio" name="reason" value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ"> ‡∏≠‡∏∑‡πà‡∏ô‡πÜ</label>
            <input id="reasonOther" class="border rounded px-3 py-2 w-72 hidden" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°">
          </div>
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm mb-1">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ</label>
          <select id="drugSelect" class="border rounded px-3 py-2 w-full"></select>
        </div>
      </div>
      <div class="mt-6">
        <h3 class="font-semibold mb-2">‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏¢‡∏≤‡∏ô‡∏µ‡πâ</h3>
        <div class="overflow-x-auto">
          <table class="min-w-full border">
            <thead>
              <tr>
                <th class="p-2 border w-48">Lot EXP</th>
                <th class="p-2 border w-32">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                <th class="p-2 border w-44">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ</th>
              </tr>
            </thead>
            <tbody id="stockBody"></tbody>
          </table>
        </div>
      </div>
      <div class="mt-6">
        <div class="flex items-center justify-between mb-2">
          <h3 class="font-semibold">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà (‡πÉ‡∏™‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏•‡πà‡∏≠‡∏á)</h3>
          <div class="muted text-sm">‡∏Å‡∏î ‚Äú+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‚Äù ‡∏Å‡∏£‡∏ì‡∏µ‡∏¢‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</div>
        </div>
        <div class="grid md:grid-cols-3 gap-2">
          <div>
            <label class="block text-sm mb-1">‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ (EXP)</label>
            <input type="date" id="addExp" class="border rounded px-3 py-2 w-full">
          </div>
          <div>
            <label class="block text-sm mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
            <input type="number" id="addQty" min="0" step="1" class="border rounded px-3 py-2 w-full" placeholder="‡πÄ‡∏ä‡πà‡∏ô 2">
          </div>
          <div class="flex items-end">
            <button id="addNewBtn" class="btn">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
          </div>
        </div>
        <div id="newList" class="mt-3 space-y-2"></div>
        <div id="newEmpty" class="muted text-sm mt-2">‚Äî ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà ‚Äî</div>
      </div>
      <div class="mt-6 flex gap-2 items-center">
        <button id="submitBtn" class="btn primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        <div id="saveMsg" class="muted"></div>
      </div>
    </section>

    <!-- Page: Summary/Dashboard View -->
    <section id="view-output" class="card p-4 hidden">
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-xl font-semibold">‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏¢‡∏≤</h2>
      </div>
      <div id="dashboardAll" class="space-y-4"></div>
    </section>
  </div>

  <!-- QR and Need-add Modal omitted for brevity -->

  <script>
    const API_BASE = 'https://script.google.com/macros/s/AKfycbxThaOhEpXuhcGQ-6YuGefh0WQb9SQBlozZzFm3q5iBwzQaY-NtEMZ09HWB602lZSqW/exec';
    let currentBox = localStorage.getItem('em_box') || '';
    // ... All helper functions, loadBoxes(), loadItems(), loadLots(), renderStockTable(), addNewLot(), submitData(), etc. (same as before)

    async function loadDashboardAll(){
      if (!currentBox) return;
      const d1 = await apiGet({ action: 'dashboard', box: currentBox });
      const d2 = await apiGet({ action: 'summary_all' });
      renderDashboardAll(d1, d2);
    }

    function renderDashboardAll(dBox, dAll){
      const wrap = document.getElementById('dashboardAll');
      wrap.innerHTML = '';

      const card1 = document.createElement('div');
      card1.className = 'p-4 border rounded bg-white';
      card1.innerHTML = `
        <div class="font-semibold mb-2">‡∏Å‡∏•‡πà‡∏≠‡∏á ${currentBox}</div>
        <div class="mb-1">üîπ <b>‡∏¢‡∏≤‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î:</b> ${dBox?.soonestDate || '‚Äî'}</div>
        <div class="mb-1">üì¶ <b>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:</b> ${dBox?.soonest?.length || 0} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
        <div class="mb-1">üìä <b>‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô:</b> ${dBox?.visits?.total || 0} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${dBox?.visits?.lastDate || '-'})</div>
        <div class="muted text-sm">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ‡∏¢‡∏≤‡πÉ‡∏Å‡∏•‡πâ EXP ${dBox?.visits?.byReason?.['‡∏¢‡∏≤‡πÉ‡∏Å‡∏•‡πâ EXP']||0}, ‡πÉ‡∏ä‡πâ‡∏¢‡∏≤‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á ${dBox?.visits?.byReason?.['‡πÉ‡∏ä‡πâ‡∏¢‡∏≤‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á']||0}, ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ${dBox?.visits?.byReason?.['‡∏≠‡∏∑‡πà‡∏ô‡πÜ']||0}</div>
      `;
      wrap.appendChild(card1);

      const card2 = document.createElement('div');
      card2.className = 'p-4 border rounded bg-white';
      card2.innerHTML = `
        <div class="font-semibold mb-2">üìã ‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏Å‡∏•‡πà‡∏≠‡∏á</div>
        <div class="mb-1">üßæ <b>‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</b> ${dAll?.total || 0} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
        <div class="muted text-sm">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ‡∏¢‡∏≤‡πÉ‡∏Å‡∏•‡πâ EXP ${dAll?.reasons?.['‡∏¢‡∏≤‡πÉ‡∏Å‡∏•‡πâ EXP']||0}, ‡πÉ‡∏ä‡πâ‡∏¢‡∏≤‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á ${dAll?.reasons?.['‡πÉ‡∏ä‡πâ‡∏¢‡∏≤‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á']||0}, ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ${dAll?.reasons?.['‡∏≠‡∏∑‡πà‡∏ô‡πÜ']||0}</div>
      `;
      wrap.appendChild(card2);
    }

    window.addEventListener('DOMContentLoaded', () => {
      setBoxBadge();
      loadBoxes();
      document.getElementById('tab-view').onclick = () => {
        if (!currentBox) { switchView('view-select'); }
        else { switchView('view-output'); loadDashboardAll(); }
      };
      //... remaining event listeners (QR, form etc.)
    });
  </script>
</body>
</html>

<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Emergency Med Box</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 4px 16px rgba(0,0,0,.05)}
    .btn{border-radius:.5rem;padding:.5rem .9rem;border:1px solid #e5e7eb;background:#f8fafc}
    .btn.primary{background:#2563eb;color:#fff;border-color:#2563eb}
    .muted{color:#64748b}
    .chip{background:#eef2ff;border:1px solid #c7d2fe;border-radius:9999px;padding:.25rem .6rem;font-size:.75rem}
    thead th{background:#f1f5f9}
    .stepper{display:flex;align-items:center;gap:.25rem}
    .stepper button{width:32px;height:32px;border:1px solid #e5e7eb;border-radius:.5rem;background:#fff}
    .stepper input{width:72px;text-align:center;border:1px solid #e5e7eb;border-radius:.5rem;padding:.35rem}
    #apiBanner{display:none}
    /* ‡∏õ‡πâ‡∏≤‡∏¢ + ‡πÑ‡∏Æ‡πÑ‡∏•‡∏ï‡πå‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏£‡∏Å */
    .badge-nearest{background:#fef3c7;border:1px solid #f59e0b;color:#92400e;padding:.15rem .5rem;border-radius:9999px;font-size:.75rem}
    .near-first{background:#fffbeb;border-color:#fbbf24}
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
<div class="max-w-5xl mx-auto p-4 md:p-6">

  <div id="apiBanner" class="mb-3 rounded-lg border border-amber-300 bg-amber-50 text-amber-800 px-3 py-2 text-sm"></div>

  <header class="flex items-center justify-between mb-4">
    <div class="flex items-center gap-2">
      <h1 class="text-2xl font-bold">‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Ñ‡∏¢‡∏≤‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏¢‡∏≤‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</h1>
      <span id="boxBadge" class="chip hidden"></span>
    </div>
    <button id="qrBtn" class="btn">QR</button>
  </header>

  <div class="grid md:grid-cols-2 gap-3 mb-4">
    <button id="tab-form" class="btn card text-left">‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    <button id="tab-view" class="btn card text-left">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•</button>
  </div>

  <!-- ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
  <section id="view-form" class="card p-4">
    <h2 class="text-xl font-semibold mb-4">‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤ Google Sheet)</h2>

    <div class="grid md:grid-cols-2 gap-4">
      <div>
        <label class="block text-sm mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏¢‡∏≤</label>
        <select id="boxSelect" class="border rounded px-3 py-2 w-full"></select>
      </div>
      <div>
        <label class="block text-sm mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏ó‡∏µ‡πà‡∏´‡πâ‡∏≠‡∏á‡∏¢‡∏≤</label>
        <input type="date" id="dateVisit" class="border rounded px-3 py-2 w-full">
      </div>

      <div>
        <label class="block text-sm mb-1">‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</label>
        <select id="inspector" class="border rounded px-3 py-2 w-full">
          <option value="">- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å -</option>
          <option>‡∏†‡∏ç.‡∏û‡∏ô‡∏≤‡∏£‡∏±‡∏ï‡∏ô‡πå</option>
          <option>‡∏†‡∏ç.‡∏û‡∏±‡∏ä‡∏£‡∏µ‡∏ß‡∏£‡∏£‡∏ì</option>
          <option>‡∏†‡∏Å.‡∏≠‡∏ô‡∏∏‡∏û‡∏á‡∏®‡πå</option>
          <option>‡∏†‡∏ç.‡∏≠‡∏†‡∏¥‡∏ç‡∏ç‡∏≤</option>
          <option>‡∏†‡∏ç.‡∏™‡∏∏‡∏£‡∏µ‡∏ß‡∏±‡∏í‡∏ô‡πå</option>
        </select>
      </div>

      <div>
        <label class="block text-sm mb-1">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ</label>
        <div class="flex flex-wrap items-center gap-4">
          <label class="inline-flex items-center gap-2"><input type="radio" name="reason" value="‡∏¢‡∏≤‡πÉ‡∏Å‡∏•‡πâ EXP"> ‡∏¢‡∏≤‡πÉ‡∏Å‡∏•‡πâ EXP</label>
          <label class="inline-flex items-center gap-2"><input type="radio" name="reason" value="‡πÉ‡∏ä‡πâ‡∏¢‡∏≤‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á" checked> ‡πÉ‡∏ä‡πâ‡∏¢‡∏≤‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á</label>
          <label class="inline-flex items-center gap-2"><input type="radio" name="reason" value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ"> ‡∏≠‡∏∑‡πà‡∏ô‡πÜ</label>
          <input id="reasonOther" class="border rounded px-3 py-2 w-72 hidden" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°">
        </div>
      </div>

      <div class="md:col-span-2">
        <label class="block text-sm mb-1">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏•‡πá‡∏≠‡∏ï/‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)</label>
        <select id="drugSelect" class="border rounded px-3 py-2 w-full"></select>
      </div>
    </div>

    <!-- ‡∏™‡∏ï‡πá‡∏≠‡∏Å -->
    <div class="mt-6">
      <h3 class="font-semibold mb-2">‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏¢‡∏≤‡∏ô‡∏µ‡πâ</h3>
      <div class="overflow-x-auto">
        <table class="min-w-full border">
          <thead>
            <tr>
              <th class="p-2 border w-48">Lot EXP</th>
              <th class="p-2 border w-32">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
              <th class="p-2 border w-44">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ</th>
            </tr>
          </thead>
          <tbody id="stockBody"></tbody>
        </table>
      </div>
    </div>

    <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà -->
    <div class="mt-6">
      <div class="flex items-center justify-between mb-2">
        <h3 class="font-semibold">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà (‡πÉ‡∏™‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏•‡πà‡∏≠‡∏á)</h3>
        <div class="muted text-sm">‡∏Å‡∏î ‚Äú+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‚Äù ‡∏Å‡∏£‡∏ì‡∏µ‡∏¢‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</div>
      </div>
      <div class="grid md:grid-cols-3 gap-2">
        <div>
          <label class="block text-sm mb-1">‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ (EXP)</label>
          <input type="date" id="addExp" class="border rounded px-3 py-2 w-full">
        </div>
        <div>
          <label class="block text-sm mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
          <input type="number" id="addQty" min="0" step="1" class="border rounded px-3 py-2 w-full" placeholder="‡πÄ‡∏ä‡πà‡∏ô 2">
        </div>
        <div class="flex items-end">
          <button id="addNewBtn" class="btn">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
        </div>
      </div>
      <div id="newList" class="mt-3 space-y-2"></div>
      <div id="newEmpty" class="muted text-sm mt-2">‚Äî ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà ‚Äî</div>
    </div>

    <div class="mt-6 flex gap-2 items-center">
      <button id="submitBtn" class="btn primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      <div id="saveMsg" class="muted"></div>
    </div>
  </section>

  <!-- ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ -->
  <section id="view-output" class="card p-4 hidden">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-xl font-semibold">‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏•‡∏∞‡∏¢‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</h2>
      <div class="flex items-center gap-2">
        <label class="muted">‡∏Å‡∏•‡πà‡∏≠‡∏á</label>
        <select id="boxViewSelect" class="border rounded px-2 py-1"></select>
        <label class="ml-3 muted">‡∏†‡∏≤‡∏¢‡πÉ‡∏ô (‡∏ß‡∏±‡∏ô)</label>
        <input id="nearDays" type="number" min="1" value="1000" class="border rounded px-3 py-1 w-24">
        <button id="refreshNearBtn" class="btn">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
      </div>
    </div>
    <div id="nearList" class="space-y-2"></div>
  </section>
</div>

<!-- QR Modal -->
<div id="qrModal" class="fixed inset-0 bg-black/50 hidden z-50">
  <div class="min-h-full flex items-center justify-center p-4">
    <div class="bg-white rounded-xl p-5 w-full max-w-sm text-center">
      <h3 class="text-lg font-semibold mb-3">‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏≠‡∏õ (‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡πà‡∏≠‡∏á)</h3>
      <div id="qrBox" class="mb-3 flex justify-center"></div>
      <input id="qrLink" class="border rounded px-3 py-2 w-full text-sm mb-3" readonly>
      <div class="flex justify-center gap-2">
        <button id="qrCopy" class="btn">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå</button>
        <button id="qrDL" class="btn">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î QR</button>
        <button id="qrClose" class="btn">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
  </div>
</div>

<!-- Need-add modal -->
<div id="modalNeedAdd" class="fixed inset-0 bg-black/50 hidden z-50">
  <div class="min-h-full flex items-center justify-center p-4">
    <div class="bg-white rounded-xl p-5 w-full max-w-lg">
      <h3 class="text-lg font-semibold mb-2">‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡πá‡∏≠‡∏ï‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</h3>
      <div id="modalNeedAddMsg" class="text-slate-700 mb-4"></div>
      <div class="flex justify-end gap-2">
        <button id="modalNeedAddClose" class="btn">‡∏õ‡∏¥‡∏î</button>
        <button id="modalNeedAddGo" class="btn primary">‡πÑ‡∏õ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡πá‡∏≠‡∏ï</button>
      </div>
    </div>
  </div>
</div>

<script>
// ===== CONFIG =====
const API_BASE = 'https://script.google.com/macros/s/AKfycby-E09fD2kwEVIXdJtfKkATXVPidEa3VcAg7p6RmKkGlUFcsTLPFm0SVIDCnwcx-Lb4/exec'; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì

// ===== STATE =====
let currentBox = localStorage.getItem('em_box') || '';
let currentLots = [];
let useInputs   = {}; // exp -> qtyUsed
let newLotsPend = [];

// ===== Helpers =====
function setBoxBadge(){ const el=document.getElementById('boxBadge'); if(currentBox){ el.textContent='‡∏Å‡∏•‡πà‡∏≠‡∏á: '+currentBox; el.classList.remove('hidden'); } else { el.classList.add('hidden'); } }
function switchView(id){ ['view-form','view-output'].forEach(v=>document.getElementById(v).classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); }
function toast(el,msg){ el.textContent = msg; setTimeout(()=> el.textContent='', 3000); }

async function apiGet(p){
  const url = API_BASE + '?' + new URLSearchParams(p).toString();
  const r = await fetch(url, { cache:'no-store' });
  const txt = await r.text();
  try { hideApiBanner(); return JSON.parse(txt); }
  catch { showApiBanner('‚ö†Ô∏è ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö JSON'); return {}; }
}
async function apiPost(payload){
  const r = await fetch(API_BASE,{ method:'POST', headers:{'Content-Type':'text/plain; charset=UTF-8'}, body: JSON.stringify(payload) });
  return r.json();
}
function showApiBanner(msg){ const b=document.getElementById('apiBanner'); b.textContent=msg; b.style.display='block'; }
function hideApiBanner(){ const b=document.getElementById('apiBanner'); b.style.display='none'; b.textContent=''; }

// ===== Boxes / Items / Lots =====
async function loadBoxes(){
  const data = await apiGet({action:'boxes'});
  const boxes = data.boxes && data.boxes.length ? data.boxes : ['IPD01','ER01','ER02','ER03'];

  // ‡∏ü‡∏≠‡∏£‡πå‡∏°
  const selForm = document.getElementById('boxSelect');
  selForm.innerHTML = '';
  boxes.forEach(b=>{
    const o=document.createElement('option'); o.value=b; o.textContent=b; selForm.appendChild(o);
  });
  if(currentBox && boxes.includes(currentBox)) selForm.value=currentBox;
  else { currentBox = boxes[0]; selForm.value=currentBox; localStorage.setItem('em_box',currentBox); }
  setBoxBadge();

  // ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
  const selView = document.getElementById('boxViewSelect');
  selView.innerHTML = '';
  boxes.forEach(b=>{
    const o=document.createElement('option'); o.value=b; o.textContent=b; selView.appendChild(o);
  });
  selView.value = currentBox;

  await loadItems(); await loadLots(); await loadNear();
}
async function loadItems(){
  if(!currentBox) return;
  useInputs={}; newLotsPend=[]; renderNewList();
  const data = await apiGet({action:'items', box: currentBox});
  const sel = document.getElementById('drugSelect'); sel.innerHTML='';
  const o0=document.createElement('option'); o0.value=''; o0.textContent='- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏¢‡∏≤ -'; sel.appendChild(o0);
  (data.items||[]).forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; sel.appendChild(o); });
}
function makeStepper(exp, maxQty){
  const wrap=document.createElement('div'); wrap.className='stepper';
  const minus=document.createElement('button'); minus.textContent='‚àí';
  const input=document.createElement('input'); input.type='number'; input.min='0'; input.max=String(maxQty); input.value=String(useInputs[exp]||0); input.dataset.exp=exp;
  const plus=document.createElement('button'); plus.textContent='+';
  const clamp=()=>{ let v=Number(input.value)||0; if(v<0)v=0; if(v>maxQty)v=maxQty; input.value=String(v); useInputs[exp]=v; };
  minus.onclick=()=>{ input.value=String(Math.max(0,(Number(input.value)||0)-1)); clamp(); };
  plus.onclick =()=>{ input.value=String(Math.min(maxQty,(Number(input.value)||0)+1)); clamp(); };
  input.oninput = clamp;
  wrap.append(minus,input,plus);
  return wrap;
}
function renderStockTable(){
  const tb=document.getElementById('stockBody'); tb.innerHTML='';
  if(!currentLots.length){
    const tr=document.createElement('tr'); const td=document.createElement('td'); td.colSpan=3; td.className='border p-3 muted'; td.textContent='‚Äî ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡πá‡∏≠‡∏ï‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏≠‡∏á‡∏¢‡∏≤‡∏ô‡∏µ‡πâ ‚Äî';
    tr.appendChild(td); tb.appendChild(tr); return;
  }
  currentLots.forEach(l=>{
    const tr=document.createElement('tr');
    const c1=document.createElement('td'); c1.className='border p-2'; c1.textContent=l.expISO||'-';
    const c2=document.createElement('td'); c2.className='border p-2 text-right'; c2.textContent=l.qty;
    const c3=document.createElement('td'); c3.className='border p-2'; c3.appendChild(makeStepper(l.expISO,l.qty));
    tr.append(c1,c2,c3); tb.appendChild(tr);
  });
}
async function loadLots(){
  const drug = document.getElementById('drugSelect').value.trim();
  useInputs={}; newLotsPend=[]; renderNewList();
  if(!currentBox || !drug){ currentLots=[]; renderStockTable(); return; }
  const data = await apiGet({action:'lots', box: currentBox, drug});
  currentLots = data.lots || [];
  renderStockTable();
}

// ===== New lots =====
function renderNewList(){
  const wrap=document.getElementById('newList'); const empty=document.getElementById('newEmpty'); wrap.innerHTML='';
  if(!newLotsPend.length){ empty.classList.remove('hidden'); return; }
  empty.classList.add('hidden');
  newLotsPend.forEach((n,idx)=>{ const row=document.createElement('div'); row.className='flex items-center justify-between p-2 border rounded bg-white'; row.innerHTML=`<div>EXP: <span class="font-medium">${n.exp}</span> ‚Äî ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: <span class="font-medium">${n.qty}</span></div>`; const del=document.createElement('button'); del.className='btn'; del.textContent='‡∏•‡∏ö'; del.onclick=()=>{ newLotsPend.splice(idx,1); renderNewList(); }; row.appendChild(del); wrap.appendChild(row); });
}
function addNewLot(){
  const exp=(document.getElementById('addExp').value||'').trim();
  const qty=Math.max(0, Number(document.getElementById('addQty').value)||0);
  if(!exp){ alert('‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏'); return; }
  if(qty<=0){ alert('‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (>0)'); return; }
  newLotsPend.push({exp, qty}); renderNewList();
  document.getElementById('addExp').value=''; document.getElementById('addQty').value='';
}

// ===== Submit =====
async function submitData(){
  const msg=document.getElementById('saveMsg');
  const dateVisit=document.getElementById('dateVisit').value || new Date().toISOString().slice(0,10);
  const inspector=document.getElementById('inspector').value || '';
  const reason=getReason();
  const drug=document.getElementById('drugSelect').value.trim();
  if(!currentBox){ toast(msg,'‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡πà‡∏≠‡∏á'); return; }
  if(!drug){ toast(msg,'‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏¢‡∏≤'); return; }
  if(!reason){ toast(msg,'‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ'); return; }

  const usedLots = Object.entries(useInputs).filter(([_,q])=>(Number(q)||0)>0).map(([exp,qty])=>({exp, qtyUsed:Number(qty)}));

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡πà‡∏≤‡∏û‡∏≠‡πÑ‡∏´‡∏° (‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏à‡∏£‡∏¥‡∏á + ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°)
  const stockMap={}; (currentLots||[]).forEach(l=>{ stockMap[l.expISO]=(stockMap[l.expISO]||0)+(Number(l.qty)||0); });
  const addMap={}; (newLotsPend||[]).forEach(n=>{ addMap[n.exp]=(addMap[n.exp]||0)+(Number(n.qty)||0); });
  const insufficient=[];
  usedLots.forEach(u=>{ const have=(stockMap[u.exp]||0)+(addMap[u.exp]||0); if(u.qtyUsed>have) insufficient.push({exp:u.exp, want:u.qtyUsed, have}); });
  if(insufficient.length){
    const list=insufficient.map(x=>`<li>Lot EXP: <b>${x.exp}</b> (‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ ${x.want} ‡πÅ‡∏ï‡πà‡∏°‡∏µ/‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ß‡πâ‡∏£‡∏ß‡∏° ${x.have})</li>`).join('');
    openNeedAddModal(`<p>‡∏û‡∏ö‡∏•‡πá‡∏≠‡∏ï‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡πÑ‡∏°‡πà‡∏û‡∏≠:</p><ul class="list-disc pl-5 mt-2">${list}</ul><p class="mt-3">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏™‡πà‡∏ß‡∏ô <b>‚Äú‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà (‡πÉ‡∏™‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏•‡πà‡∏≠‡∏á)‚Äù</b> ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î <b>+ ‡πÄ‡∏û‡∏¥‡πà‡∏°</b> ‡∏Å‡πà‡∏≠‡∏ô ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏Ñ‡πà‡∏≠‡∏¢‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>`);
    return;
  }

  try{
    const res = await apiPost({ box: currentBox, dateVisit, drug, reason, inspector, usedLots, newLots: newLotsPend });
    if(res.ok){
      toast(msg,'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß');
      useInputs={}; newLotsPend=[]; renderNewList();
      await loadLots(); await loadNear();
    }else{
      toast(msg,'‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + res.error);
    }
  }catch(e){
    toast(msg,'‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ' + (e?.message||e));
  }
}

// ===== Reason & Near =====
function getReason(){ const r=document.querySelector('input[name="reason"]:checked'); if(!r) return ''; if(r.value==='‡∏≠‡∏∑‡πà‡∏ô‡πÜ') return document.getElementById('reasonOther').value.trim(); return r.value; }

async function loadNear(){
  if(!currentBox) return;
  const days = Number(document.getElementById('nearDays').value)||1000;
  const data = await apiGet({action:'near', box: currentBox, days});
  const list=document.getElementById('nearList'); list.innerHTML='';
  const title=document.createElement('div'); title.className='mb-2 muted'; title.textContent=`‡∏Å‡∏•‡πà‡∏≠‡∏á: ${currentBox} ‚Äî ‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡∏´‡∏°‡∏î‡∏†‡∏≤‡∏¢‡πÉ‡∏ô ${data.days||days} ‡∏ß‡∏±‡∏ô`; list.appendChild(title);
  (data.rows||[]).forEach((r,idx)=>{ 
    const el=document.createElement('div'); 
    el.className='p-3 border rounded flex items-center justify-between ' + (idx===0?'near-first':'');
    el.innerHTML=`<div>
        <div class="font-medium flex items-center gap-2">
          ${idx===0?'<span class="badge-nearest">‡∏¢‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</span>':''}
          ${r.drug}
        </div>
        <div class="muted">Lot EXP: ${r.expISO}</div>
      </div>
      <div class="text-right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${r.qty}</div>`;
    list.appendChild(el); 
  });
  if(!data.rows || !data.rows.length){ const empty=document.createElement('div'); empty.className='muted'; empty.textContent='‚Äî ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‚Äî'; list.appendChild(empty); }
}

// ===== Events =====
window.addEventListener('DOMContentLoaded', ()=>{
  document.getElementById('dateVisit').value = new Date().toISOString().slice(0,10);
  setBoxBadge(); loadBoxes();

  // ‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤
  document.getElementById('tab-form').onclick = ()=>{ switchView('view-form'); };
  document.getElementById('tab-view').onclick = ()=>{ switchView('view-output'); loadNear(); };

  // ‡∏Å‡∏•‡πà‡∏≠‡∏á/‡∏¢‡∏≤/‡∏•‡πá‡∏≠‡∏ï
  document.getElementById('boxSelect').addEventListener('change', async (e)=>{
    currentBox = e.target.value; localStorage.setItem('em_box', currentBox); setBoxBadge();
    document.getElementById('boxViewSelect').value = currentBox;
    await loadItems(); await loadLots(); 
  });
  document.getElementById('boxViewSelect').addEventListener('change', async (e)=>{
    currentBox = e.target.value; localStorage.setItem('em_box', currentBox); setBoxBadge();
    document.getElementById('boxSelect').value = currentBox;
    await loadNear(); await loadItems(); await loadLots();
  });

  document.getElementById('drugSelect').addEventListener('change', loadLots);
  document.getElementById('addNewBtn').onclick = addNewLot;
  document.getElementById('submitBtn').onclick = submitData;
  document.getElementById('refreshNearBtn').onclick = loadNear;

  // QR
  document.getElementById('qrBtn').onclick = ()=>{
    const url = window.location.origin + window.location.pathname.replace(/index\.html?$/,'');
    const appUrl = url.endsWith('/')? (url+'?view=select'):(url+'/?view=select');
    const box=document.getElementById('qrBox'); box.innerHTML='';
    new QRCode(box,{text:appUrl,width:256,height:256,correctLevel:QRCode.CorrectLevel.M});
    document.getElementById('qrLink').value=appUrl;
    document.getElementById('qrModal').classList.remove('hidden');
  };
  document.getElementById('qrClose').onclick=()=> document.getElementById('qrModal').classList.add('hidden');
  document.getElementById('qrDL').onclick=()=>{
    const img=document.querySelector('#qrBox img'); const canvas=document.querySelector('#qrBox canvas');
    const src=img?img.src:(canvas?canvas.toDataURL('image/png'):null); if(!src) return; const a=document.createElement('a'); a.href=src; a.download='app-qr.png'; a.click();
  };
  document.getElementById('qrCopy').onclick=async ()=>{
    const v=document.getElementById('qrLink').value; try{ await navigator.clipboard.writeText(v); alert('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏•‡πâ‡∏ß'); }catch{ alert(v); }
  };
  document.getElementById('qrModal').addEventListener('click',(e)=>{ if(e.target.id==='qrModal') document.getElementById('qrModal').classList.add('hidden'); });
});
  <h3>üìò ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö EMER-BOX</h3>
<a href="EMER-BOX-MANUAL1.pdf" target="_blank"
   style="display:inline-block;margin:8px;padding:10px 18px;
          background:#007bff;color:#fff;text-decoration:none;
          border-radius:8px;">
  ‡πÄ‡∏õ‡∏¥‡∏î‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (PDF)
</a>

<a href="EMER-BOX-MANUAL2.pdf" target="_blank"
   style="display:inline-block;margin:8px;padding:10px 18px;
          background:#28a745;color:#fff;text-decoration:none;
          border-radius:8px;">
  ‡πÄ‡∏õ‡∏¥‡∏î‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (PDF)
</a>
</script>
</body>
</html>

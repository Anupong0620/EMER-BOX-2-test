<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Emergency Med Box</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card { background: #fff; border-radius: 1rem; padding: 1rem; box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
    .hidden { display: none; }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">

<div class="max-w-4xl mx-auto p-4">
  <h1 class="text-2xl font-bold mb-4">ระบบตรวจเช็คยาในกล่องยาฉุกเฉิน</h1>

  <!-- ปุ่มสลับแท็บ -->
  <div class="flex gap-2 mb-4">
    <button onclick="switchTab('select')" class="btn bg-white border px-4 py-2 rounded">หน้า 1: เลือกกล่องยา</button>
    <button onclick="switchTab('form')" class="btn bg-white border px-4 py-2 rounded">หน้า 2: ลงข้อมูล</button>
    <button onclick="switchTab('summary')" class="btn bg-white border px-4 py-2 rounded">หน้าแสดงผล</button>
  </div>

  <!-- หน้าเลือกกล่องยา -->
  <div id="tab-select" class="card mb-4">
    <h2 class="font-semibold mb-2">เลือกกล่องยา</h2>
    <input id="boxInput" class="border px-3 py-2 rounded w-64" placeholder="หรือพิมพ์เอง เช่น ER03" />
    <button onclick="setBox()" class="btn bg-blue-600 text-white px-4 py-2 rounded ml-2">เลือกกล่องนี้</button>
    <button onclick="clearBox()" class="btn bg-gray-200 px-4 py-2 rounded ml-2">ล้าง</button>
  </div>

  <!-- หน้า dashboard -->
  <div id="tab-summary" class="card hidden">
    <h2 class="font-semibold mb-4">หน้าแสดงผล (Dashboard)</h2>
    
    <div id="boxInfo" class="mb-4 text-lg font-medium">กล่อง: —</div>

    <div class="grid md:grid-cols-2 gap-4">
      <div class="card">
        <div class="text-sm text-gray-500 mb-1">ยาใกล้หมดอายุมากที่สุดในกล่อง</div>
        <div id="soonestDrug" class="font-medium">—</div>
        <div id="soonestExp" class="text-sm text-gray-500">EXP: —</div>
      </div>
      <div class="card">
        <div class="text-sm text-gray-500 mb-1">การใช้กล่องนี้ (แยกตามเหตุผล)</div>
        <div id="boxStats" class="text-sm text-gray-700">—</div>
      </div>
    </div>

    <div class="card mt-6">
      <h3 class="font-semibold mb-2">สรุปจำนวนการใช้บริการกล่องทั้งหมด</h3>
      <div id="allStats" class="text-sm text-gray-700">—</div>
    </div>
  </div>

  <!-- หน้าฟอร์ม (ยังไม่ทำงาน) -->
  <div id="tab-form" class="card hidden">
    <h2 class="font-semibold mb-2">หน้านี้สำหรับลงข้อมูล (ยังไม่เปิดใช้งาน)</h2>
  </div>
</div>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbxThaOhEpXuhcGQ-6YuGefh0WQb9SQBlozZzFm3q5iBwzQaY-NtEMZ09HWB602lZSqW/exec';
let currentBox = '';

function switchTab(id) {
  ['select', 'form', 'summary'].forEach(t => {
    document.getElementById('tab-' + t).classList.add('hidden');
  });
  document.getElementById('tab-' + id).classList.remove('hidden');

  // โหลดข้อมูลเมื่อเข้า summary
  if (id === 'summary') {
    loadDashboard();
    loadSummaryAll();
  }
}

function setBox() {
  const input = document.getElementById('boxInput').value.trim();
  if (!input) return alert('กรุณาระบุชื่อกล่อง');
  currentBox = input.toUpperCase();
  document.getElementById('boxInfo').textContent = `กล่อง: ${currentBox}`;
  switchTab('summary');
}

function clearBox() {
  currentBox = '';
  document.getElementById('boxInput').value = '';
  switchTab('select');
}

// ========== โหลด Dashboard ==========

async function loadDashboard() {
  if (!currentBox) return;

  try {
    const r = await fetch(`${API_URL}?action=dashboard&box=${currentBox}`);
    const j = await r.json();
    if (!j.ok) throw new Error(j.error || 'โหลด dashboard ไม่สำเร็จ');

    // ยาใกล้หมด
    if (j.soonest && j.soonest.length > 0) {
      const list = j.soonest.map(d => `${d.drug} (${d.qty})`).join(', ');
      document.getElementById('soonestDrug').textContent = list;
      document.getElementById('soonestExp').textContent = 'EXP: ' + j.soonestDate;
    } else {
      document.getElementById('soonestDrug').textContent = '— ไม่มีข้อมูล —';
      document.getElementById('soonestExp').textContent = '';
    }

    // การใช้งาน
    const v = j.visits || {}, by = v.byReason || {};
    document.getElementById('boxStats').innerHTML =
      `<b>${v.total || 0} ครั้ง</b> — ยาใกล้ EXP: ${by['ยาใกล้ EXP'] || 0}, ใช้ยาในกล่อง: ${by['ใช้ยาในกล่อง'] || 0}, อื่นๆ/ไม่ระบุ: ${(by['อื่นๆ'] || 0) + (by['ไม่ระบุ'] || 0)}<br>
       ครั้งล่าสุด: ${v.lastDate || '-'}`;
  } catch (err) {
    alert('โหลด Dashboard ไม่สำเร็จ: ' + err.message);
  }
}

async function loadSummaryAll() {
  try {
    const r = await fetch(`${API_URL}?action=summary_all`);
    const j = await r.json();
    if (!j.ok) throw new Error(j.error || 'โหลด summary_all ไม่สำเร็จ');

    const reasons = j.reasons || {};
    document.getElementById('allStats').innerHTML =
      `<b>รวมทั้งหมด ${j.total || 0} ครั้ง</b><br>
       ยาใกล้ EXP: ${reasons['ยาใกล้ EXP'] || 0}<br>
       ใช้ยาในกล่อง: ${reasons['ใช้ยาในกล่อง'] || 0}<br>
       อื่นๆ: ${reasons['อื่นๆ'] || 0}`;
  } catch (err) {
    document.getElementById('allStats').textContent = 'โหลดข้อมูล summary ไม่ได้';
  }
}
</script>

</body>
</html>

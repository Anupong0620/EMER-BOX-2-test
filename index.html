/***** CONFIG *****/
const SPREADSHEET_ID = 'https://script.google.com/macros/s/AKfycbxThaOhEpXuhcGQ-6YuGefh0WQb9SQBlozZzFm3q5iBwzQaY-NtEMZ09HWB602lZSqW/exec'; // ว่างได้ถ้าเป็นสคริปต์ที่ผูกกับชีต (container-bound)
const SHEET_INV  = 'Inventory';
const SHEET_TX   = 'Transactions';
const SHEET_SOON = 'Summary_Soonest';
const NEAR_EXPIRY_DAYS_DEFAULT = 90;

const HEADERS_INV = ['Box','Drug','EXP','Qty'];
const HEADERS_TX  = ['Timestamp','DateVisit','Box','Drug','Action','EXP','Qty','Reason','Inspector','UserAgent','Meta'];

/***** HELPERS *****/
function _ss(){
  try{
    if (SPREADSHEET_ID) return SpreadsheetApp.openById(SPREADSHEET_ID);
    return SpreadsheetApp.getActive();
  }catch(e){
    throw new Error('เปิดสเปรดชีตไม่ได้: ' + e);
  }
}
function _sh(name){
  const ss=_ss(); let sh=ss.getSheetByName(name);
  if(!sh){
    sh = ss.insertSheet(name);
    const headers = (name===SHEET_INV)?HEADERS_INV:(name===SHEET_TX)?HEADERS_TX:null;
    if(headers) sh.getRange(1,1,1,headers.length).setValues([headers]);
  }
  return sh;
}

/* ✅ เวอร์ชันใหม่: รองรับ Date object, yyyy-mm-dd, และ dd/mm/yyyy (หรือ d/m/yyyy) */
function _toISODate(v){
  if(!v) return '';
  // 1) ได้เป็น Date โดยตรง
  if (Object.prototype.toString.call(v) === '[object Date]' && !isNaN(v)) {
    return Utilities.formatDate(v, Session.getScriptTimeZone(), 'yyyy-MM-dd');
  }
  // 2) yyyy-mm-dd
  if (typeof v === 'string') {
    const s = v.trim();
    if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
    // 3) dd/mm/yyyy หรือ d/m/yyyy
    const m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
    if (m) {
      const d = parseInt(m[1],10), mo = parseInt(m[2],10), y = parseInt(m[3],10);
      if (y < 1900) return ''; // กันค่าหลอกอย่าง 30/12/1899
      const js = new Date(y, mo-1, d);
      if (!isNaN(js)) return Utilities.formatDate(js, Session.getScriptTimeZone(), 'yyyy-MM-dd');
    }
  }
  // 4) เผื่อกรณี new Date() ยังพออ่านได้
  const d2 = new Date(v);
  if (!isNaN(d2)) {
    return Utilities.formatDate(d2, Session.getScriptTimeZone(), 'yyyy-MM-dd');
  }
  return '';
}

function _json(o){ return ContentService.createTextOutput(JSON.stringify(o)).setMimeType(ContentService.MimeType.JSON); }
function _bool(x){ return x===true || x==='true' || x===1 || x==='1'; }

/***** INVENTORY READERS *****/
function listBoxes(){
  const sh=_sh(SHEET_INV); const vals=sh.getDataRange().getValues();
  const set=new Set();
  for(let r=1;r<vals.length;r++){
    const box=String(vals[r][0]||'').trim();
    const qty=Number(vals[r][3]||0);
    if(box && qty>0) set.add(box);
  }
  return Array.from(set).sort();
}
function getItems(box){
  const want=String(box||'').trim();
  const sh=_sh(SHEET_INV); const vals=sh.getDataRange().getValues();
  const set=new Set();
  for(let r=1;r<vals.length;r++){
    const b=String(vals[r][0]||'').trim();
    const d=String(vals[r][1]||'').trim();
    const qty=Number(vals[r][3]||0);
    if(b===want && d && qty>0) set.add(d);
  }
  return Array.from(set).sort();
}
function getLotsForDrug(box,drug){
  const wantB=String(box||'').trim();
  const wantD=String(drug||'').trim();
  const sh=_sh(SHEET_INV); const vals=sh.getDataRange().getValues();
  const out=[];
  for(let r=1;r<vals.length;r++){
    const b=String(vals[r][0]||'').trim();
    const d=String(vals[r][1]||'').trim();
    const expISO=_toISODate(vals[r][2]);
    const qty=Number(vals[r][3]||0);
    if(b===wantB && d===wantD && qty>0 && expISO) out.push({expISO, qty});
  }
  out.sort((a,b)=> a.expISO<b.expISO ? -1 : a.expISO>b.expISO ? 1 : 0);
  return out;
}
function getNearExpiry(box, days){
  const want=String(box||'').trim();
  const cutoff=new Date(); cutoff.setDate(cutoff.getDate()+Number(days||NEAR_EXPIRY_DAYS_DEFAULT));
  const cutoffISO=_toISODate(cutoff);
  const sh=_sh(SHEET_INV); const vals=sh.getDataRange().getValues();
  const out=[];
  for(let r=1;r<vals.length;r++){
    const b=String(vals[r][0]||'').trim();
    const d=String(vals[r][1]||'').trim();
    const expISO=_toISODate(vals[r][2]);
    const qty=Number(vals[r][3]||0);
    if(b===want && qty>0 && expISO && expISO<=cutoffISO) out.push({drug:d, expISO, qty});
  }
  out.sort((a,b)=> a.expISO<b.expISO ? -1 : a.expISO>b.expISO ? 1 : 0);
  return out;
}

/***** SOONEST *****/
function getSoonestFromSummary(box){
  const ss=_ss(); const sh=ss.getSheetByName(SHEET_SOON); if(!sh) return null;
  const vals=sh.getDataRange().getValues();
  const want=String(box||'').trim();
  for(let r=1;r<vals.length;r++){
    const b=String(vals[r][0]||'').trim();
    const drug=String(vals[r][1]||'').trim();
    const expISO=_toISODate(vals[r][2]);
    const qty=Number(vals[r][3]||0);
    if(b===want && expISO) return {drug, expISO, qty};
  }
  return null;
}
function getSoonestFromInventory(box){
  const sh=_sh(SHEET_INV); const vals=sh.getDataRange().getValues();
  const want=String(box||'').trim();
  const list=[];
  for(let r=1;r<vals.length;r++){
    const b=String(vals[r][0]||'').trim();
    const drug=String(vals[r][1]||'').trim();
    const expISO=_toISODate(vals[r][2]);
    const qty=Number(vals[r][3]||0);
    if(b===want && qty>0 && expISO) list.push({drug, expISO, qty});
  }
  if(!list.length) return null;
  list.sort((a,b)=> a.expISO<b.expISO ? -1 : a.expISO>b.expISO ? 1 : 0);
  return list[0];
}
function getSoonest(box){
  return getSoonestFromSummary(box) || getSoonestFromInventory(box);
}

/***** TX SUMMARY *****/
function getVisitsSummarySafe(box){
  const resp={ total:0, byReason:{'ยาใกล้ EXP':0,'ใช้ยาในกล่อง':0,'อื่นๆ/ไม่ระบุ':0}, lastDate:'-' };
  const sh=_sh(SHEET_TX); if(!sh) return resp;
  const vals=sh.getDataRange().getValues(); const want=String(box||'').trim();
  for(let r=1;r<vals.length;r++){
    const b=String(vals[r][2]||'').trim();
    if(b!==want) continue;
    const dv=_toISODate(vals[r][1]);
    const reason=String(vals[r][7]||'').trim();
    if(dv) resp.lastDate = dv;
    if(reason){
      resp.total++;
      if(resp.byReason.hasOwnProperty(reason)) resp.byReason[reason]++; else resp.byReason['อื่นๆ/ไม่ระบุ']++;
    }
  }
  return resp;
}

/***** INVENTORY MUTATORS *****/
function addInventory_NewLot(box, drug, expISO, qty){
  const sh=_sh(SHEET_INV);
  const rng=sh.getDataRange().getValues();
  for(let r=1;r<rng.length;r++){
    const b=String(rng[r][0]||'').trim();
    const d=String(rng[r][1]||'').trim();
    const e=_toISODate(rng[r][2]);
    if(b===box && d===drug && e===expISO){
      const cur=Number(rng[r][3]||0);
      sh.getRange(r+1,4).setValue(cur + Number(qty||0));
      return {row:r+1, before:cur, after:cur+Number(qty||0)};
    }
  }
  sh.appendRow([box, drug, expISO, Number(qty||0)]);
  return {row:sh.getLastRow(), before:0, after:Number(qty||0)};
}
function adjustInventory_UseOrDelete(box, drug, expISO, qtyUsed, toDelete){
  const sh=_sh(SHEET_INV); const vals=sh.getDataRange().getValues();
  for(let r=1;r<vals.length;r++){
    const b=String(vals[r][0]||'').trim();
    const d=String(vals[r][1]||'').trim();
    const e=_toISODate(vals[r][2]);
    if(b===box && d===drug && e===expISO){
      const cur=Number(vals[r][3]||0);
      if(_bool(toDelete) || Number(qtyUsed||0) >= cur){
        sh.deleteRow(r+1);
        return {deleted:true, before:cur, after:0};
      }else{
        const after = cur - Number(qtyUsed||0);
        sh.getRange(r+1,4).setValue(after);
        return {deleted:false, before:cur, after};
      }
    }
  }
  return {deleted:false, before:0, after:0, missing:true};
}
function logTx(o){
  const sh=_sh(SHEET_TX);
  const ua = String(o.ua||'');
  const meta = JSON.stringify(o.raw||{});
  sh.appendRow([
    new Date(), _toISODate(o.dateVisit||new Date()), o.box||'', o.drug||'',
    o.action||'', o.expISO||'', Number(o.qty||o.qtyUsed||0)||0,
    o.reason||'', o.inspector||'', ua, meta
  ]);
}

/***** HTTP APIS *****/
function doGet(e){
  try{
    const p = e.parameter || {};
    const action = (p.action||'').toLowerCase();

    if(action==='boxes') return _json({ok:true, boxes:listBoxes()});
    if(action==='items'){ if(!p.box) throw 'Missing box'; return _json({ok:true, items:getItems(p.box)}); }
    if(action==='lots'){ if(!p.box||!p.drug) throw 'Missing box/drug'; return _json({ok:true, lots:getLotsForDrug(p.box,p.drug)}); }
    if(action==='near'){ if(!p.box) throw 'Missing box'; const days=Number(p.days||NEAR_EXPIRY_DAYS_DEFAULT); return _json({ok:true, rows:getNearExpiry(p.box,days), days}); }
    if(action==='dashboard'){
      if(!p.box) throw 'Missing box';
      const soon = getSoonest(p.box);
      const visits = getVisitsSummarySafe(p.box);
      return _json({ok:true,
        soonestDate: soon? soon.expISO : null,
        soonestList: soon? soon.drug + (soon.qty? ` (คงเหลือ ${soon.qty})`:'') : '',
        visits
      });
    }
    return _json({ok:true, message:'Emergency Med Box API ready'});
  }catch(err){
    return _json({ok:false, error:String(err)});
  }
}

function doPost(e){
  try{
    const body = e.postData && e.postData.contents ? JSON.parse(e.postData.contents) : {};
    const { box, dateVisit, drug, reason, inspector, usedLots = [], newLots = [] } = body;
    if(!box) throw 'Missing box';
    if(!drug) throw 'Missing drug';
    const BOX=String(box).trim(), DRUG=String(drug).trim();
    const UA = (e && e.parameter && e.parameter.ua) || '';

    newLots.forEach(n=>{
      const expISO=_toISODate(n.exp); const qty=Number(n.qty)||0;
      if(!expISO || !qty) return;
      addInventory_NewLot(BOX, DRUG, expISO, qty);
      logTx({ dateVisit, box:BOX, drug:DRUG, action:'ADD', expISO, qty, reason, inspector, ua:UA, raw:n });
    });

    usedLots.forEach(u=>{
      const expISO=_toISODate(u.exp);
      const qtyUsed=Number(u.qtyUsed)||0;
      const toDelete=_bool(u.delete);
      if(!expISO || !(qtyUsed||toDelete)) return;
      const rs = adjustInventory_UseOrDelete(BOX, DRUG, expISO, qtyUsed, toDelete);
      logTx({ dateVisit, box:BOX, drug:DRUG, action: toDelete?'DELETE_LOT':'USE', expISO, qty:qtyUsed, reason, inspector, ua:UA, raw:rs });
    });

    return _json({ok:true, message:'Saved', summary:{ used:usedLots.length, added:newLots.length }});
  }catch(err){
    return _json({ok:false, error:String(err)});
  }
}
